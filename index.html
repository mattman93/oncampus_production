 <html>
 <body>
 	 <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
      <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
      <!-- Include all compiled plugins (below), or include individual files as needed -->
      <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<br><br><br><br><br><br><br><br><br><br><br><br><br><center>
<div id="error"><b> Make a user name to send a chat request</b></div>
 	<div id="contactform">
 	  <div class="col-sm-4">
          <div id ="registerwell" class="well well-lg">
            <center>
              <form role="form" id="adduser" action ="submitRegistration.php" method="POST">
              <div class="form-group">
                <label for="UserNameRegister">Username</label>
                <input type="text" name = "registerusername" class="form-control" id="UserNameRegister" placeholder="Register Username">
                 <input type="submit" style="height:35px; width:65px" value="register"></input>
              </div>
         	</div>
         </div>
     </div>


<div class="panel panel-primary" id="chatwindow">
  <div class="panel-heading"></div>
  	<div class="panel-body">
  		<br><center>
      <input type="submit" class="btn btn-primary" id="bttn" style="margin-left:180; margin-right:300;height:50px;width:300px;" value=""></input>
      </center>
      <div id="chatbox" border="1" style="height:100px;width:50px;"></div><br>    
		    <div class="input-group input-group-lg">
		 	<span class="input-group-addon">@</span>
		  	<input type="text" class="form-control" placeholder="Username">
	</div>
  </div>
</div>


 </center>
  <div id="map-canvas" style="width: 100%; height: 100%"></div>
</body>
</html>
<style type="text/css">
#map-canvas {
  height: 100%;
  width: 100%;
  position:absolute;
  top: 0;
  left: 0;
  z-index: 0; 
}
#contactform {
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  margin-left: 450 ;
  margin-right: 20 ;
}
#chatwindow {
	display: none;
	position: relative;
    resize: both;
	margin-left: 300 ;
  margin-right: 300 ;
	z-index: 2;
}
#error {
  display: none;
  position: relative;
  z-index: 1;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyAd_qUj056TQ8botUBBwAoRY8Mm5z4O8Lk&libraries=places"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script src="http://localhost:8080/socket.io/socket.io.js"></script>
<script>
$(document).ready(function(){
	var allMarkers = [];
	var $form    = $('#adduser');
	var $username = $('#UserNameRegister');
	var $registerwell = $('#registerwell');
  var $sendReq = $('#bttn');
	var socket  = io.connect('http://localhost:8080');
  var lat;
  var longi;
  var map;
  var uname;
  var identifier;
  var errFlag = false; 
  if (navigator.geolocation){
  	geolocate();
    navigator.geolocation.getCurrentPosition(showPosition);
    var str = "success";
    window.onload = mpld();
    function mpld(){
    socket.emit("map-loaded", str);
  }
    socket.on("send-users", function(dataArr){
    	for(var i=0; i< dataArr.length; i++){
    		if(dataArr[i].username == uname){
    			console.log("YES");
    		} else {
    			console.log("NO");
    			console.log(dataArr[i].username);
	    		var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
	    		 var mark = new google.maps.Marker({
	      			position: ltlng,
	      			map: map,
	      			title: dataArr[i].username
	      	});
	    		 google.maps.event.addListener(mark, 'click', function() {
	    		 	 console.log('HELLO');
            if(uname == undefined){
              $('#error').show();
              errFlag = true;
            } else {
              $('#chatwindow').show();
             identifier = mark.title;
            $('#bttn').attr('value', 'Send chat Request to ' + identifier);
              }
					});
	    		 allMarkers.push(mark);
	    		}
   		 }
    });
    
  }
  $form.submit(function(event){
  	event.preventDefault();
  	uname = $username.val();
    if(errFlag){
        $('#error').hide();
    }
  	socket.emit("check-in", $username.val(), lat, longi);

  	$form.hide();
  	$registerwell.hide();
  });
  $sendReq.click(function(event){
    event.preventDefault();
    console.log("derp " + identifier);
  });
  function showPosition(position){
       lat = position.coords.latitude.toString().substr(0,6);
       longi = position.coords.longitude.toString().substr(0,7);
    
      //socket.emit()
      var mapOptions = {
        center : new google.maps.LatLng(lat,longi),
        zoom : 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
       map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      var latlng = new google.maps.LatLng(lat,longi);

      google.maps.event.addDomListener(window, 'load', showPosition);
  }
  function geolocate() {
            var input = document.getElementById('AddressRegister');
            var optns = {
                types: ['address']
            };
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = new google.maps.LatLng(
                    position.coords.latitude, position.coords.longitude);
                ac = new google.maps.places.Autocomplete(input, optns).setBounds(new google.maps.LatLngBounds(geolocation, geolocation));

              });
            }
          }
          socket.on("remove-marker", function(data){
          	console.log(data);
          	for(var x=0; x<allMarkers.length; x++){
          		if(allMarkers[x].title == data){
                var temp = allMarkers[x].title;
          			allMarkers[x].setMap(null);
                if(identifier == temp){
                  $('#chatwindow').hide();
                }
            
               // break;
          		}
          	} 	
                console.log("Marker remove request recieved");
          });
                socket.on("update-map", function(dataArr){
    		  	for(var i=0; i< dataArr.length; i++){
    				if(dataArr[i].username == uname){} else {
	    			var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
	    			var mark = new google.maps.Marker({
	      				position: ltlng,
	      				map: map,
	      				title: dataArr[i].username
	      	});
	    		google.maps.event.addListener(mark, 'click', function() {
	    			console.log('HELLO');
            if(uname == undefined){
              $('#error').show();
              errFlag = true;
            } else {
              $('#chatwindow').show();
             identifier = mark.title;
            $('#bttn').attr('value', 'Send chat Request to ' + identifier);
              }
    				});
	    		allMarkers.push(mark);
	    	}
    	}
    });

});

</script>
