 <html>
 <body>
   <script src="http://45.55.159.108:80/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
 
 <!-- Optional theme -->
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
 
 <!-- Latest compiled and minified JavaScript -->
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <div id ="infowell" class="well well-lg">
    <center><div>
  <b>Welcome to OnCampus, make a user name and look for the red markers<br>
     Click on the markers to send a chat a request</b></div><div>
     <a href="#" id="closeinfo">
     Close <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></div>
     </center>
 </div>
<br><br><br><br><br><br><br><br><br><br><br><br><br><center>
<div id="allRequests"></div>
<div id="incoming-request">
  <div id ="requestWell" class="well well-lg">
    <div id="header"></div>
           <form id="accReq">
           <input type="submit" class="btn btn-success" id="btn" style="margin-left:5; margin-right:300;height:50px;width:300px;" value="Accept"></input>
         </form>
         <form id="decReq">
           <input type="submit" class="btn btn-danger" id="btn" style="margin-left:5; margin-right:300;height:50px;width:300px;" value="Decline"></input>
         </form>
  </div>
</div>
<div id="error" style="background-color: #FE2E2E;"></div>
  <div id="contactform">
    <div class="col-sm-4">
          <div id ="registerwell" class="well well-lg">
            <center>
              <form role="form" id="adduser" method="POST">
              <div class="form-group">
                <label for="UserNameRegister">Username</label>
                <input type="text" maxlength="15" name = "registerusername" class="form-control" id="UserNameRegister" placeholder="Register Username">
                 <input type="submit" style="height:35px; width:65px" value="register" id="registerBttn"></input>
              </div>
          </div>
         </div>
     </div>
<div id="admin">
<div class='col-sm-4'>
                 <div id ='adminlogin' class='well well-lg'>
                           <center>
                                     <div id="admin_message"></div>
                             <form role='form' id='admin_l' method='POST'>
                              <div class='form-group'>
                                    <input type='password' maxlength='15' name = 'loginadmin' class='form-control' id='loginadmin' placeholder='login'>
                                   <input type='submit' style='height:35px; width:65px' value='login' id='adminloginbttn'></input>
                                  </div>
                               </div>
                           </div>
                        </div>
<div class="panel panel-primary" id="chatwindow">
      <br><center>
        <div id="messages"></div>
      <div id="waiting"><b>Waiting...</b></div>
      <form id="chatReq">
      <input type="submit" class="btn btn-primary" id="bttn" value=""></input>
      </form>
      </center>
        <div class="input-group input-group-lg" id="messageSendDiv">
          <form role="form" id="sendmsg" method="post"> 
          <div class="form-group">
          <input type="text" maxlength="85" id="msg" class="form-control" placeholder="Message">&nbsp
            <!-- <input type="submit" style="height:45px;width:70px;" value="send" id="sendmsgbttn"></input> -->
             <button type="button" class="btn btn-success" id="sendmsgbttn">Send Message</button>
            <button type="button" class="btn btn-danger" id="endbttn">End Conversation</button>
           <!-- <input type="submit" style="height:45px;width:70px;" value="end conversation" id="endbttn"></input> -->
          </div>
          <div id="cancel_req">
              <button type="button" class="btn btn-danger" id="cancelbttn">Cancel Request</button>
          </div>
     </form> 
      <div><a href="#" id="closeChatWindow"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Hide Window</a></div>
      <table><tr><td>
    <div id="media_one"></div>
      </td><td>
    <div id="media_two"></div></td></tr></table>
   </div>
   <div id="stat"></div>
</div>
 </center>
    <!-- Content Modal -->
<div class="modal fade" id="view_post">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="post_user"></h4>
      </div>
      <div class="modal-body">
         <div id="post_content"></div>
      </div>
      <br><hr>
      <div id="comments_div"></div>
           <div align="center" id="textarea_div">
            <textarea class='comment_content form-control custom-control' rows='2' cols='20' style='resize:none' id='comment_content' placeholder='write a response'></textarea>
          </div><div align="center">
        <input class='post_comment btn btn-success' type='submit' style='height:45px; width:595px' value='post' id='post_comment'></input>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

  <!-- Content Modal -->
<div class="modal fade" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
         <textarea class="form-control custom-control" rows="3" cols="30" style="resize:none" id="post_cntnt"></textarea>
      </div>
      <div class="modal-footer">
        <center>
        <button type="button" class="btn btn-success" id="make_post">Post</button>
        </center>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
  <div id="map-canvas" style="width: 100%; height: 100%"></div>
    <div id="shout_content" class="well well-lg">
    <a href="#" id="closeshout"> Hide <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
    <div id="shoutbox">
      <div id="s_msgs"></div>
     <div id="postshout">
       </div>
       <form id="sendshoutform">
         <input type="text" maxlength="75" id="shouttextfield" style="width:215px;" placeholder="say something to the world" />
         <button type="button" class="btn btn-success" id="sendshoutbttn">Send</button>
       </form>
       </div>
    </div>
      <div id="hiddenShoutWindow" class="well well-lg">
        <div><a href="#" id="openShoutWindow"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Show Messages</a></div>
      </div>
  <div id="hiddenChatWindow" class="well well-lg">
<div><a href="#" id="openChatWindow"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Show Window</a></div>
</div>
  <div id="hiddenChatWindow" class="well well-lg">
<div><a href="#" id="openChatWindow"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Show Window</a></div>
</div>
  <div id="post">
    <div class="col-sm-4">
       <div id ="registerwell" class="well well-lg">
         <div class="form-group">
          <!--<form role="form" id="post_form" method="POST"> -->
          <label for="pickspot">Make a Geo Post!</label><br>
              <input class="btn btn-success" type="submit" style="height:35px; width:190px" value="Pick a spot on the map!" id="pickspot"></input>
              <input class="btn btn-danger" type="submit" style="height:35px; width:190px" value="cancel" id="cancelgeopost"></input><br><br><br><br>
          <!--  </form> -->
            </div>
          </div>
        </div>
    </div>
</body>
</html>   
<style type="text/css">
#messages
{
   height:80px;
    overflow:scroll;
    overflow-x:hidden;
}
#hiddenChatWindow {
  display: none;
  position: absolute;
  z-index: 1;
   opacity: .95;
   bottom: 2px;
}
#hiddenShoutWindow{
    display: none;
  position: absolute;
  z-index: 1;
   opacity: .95;
   bottom: 75px;
}
#shout_content {
  position: absolute;
  z-index: 1;
   opacity: .75;
   left: 4px;
   bottom: 8px;
   width: 500px;
}
#s_msgs {
  height: 300px;
  overflow: auto;
}
#map-canvas {
  height: 100%;
  width: 100%;
  position:absolute;
  top: 0;
  left: 0;
  z-index: 0;
}
#infowell {
   position: relative;
    z-index: 1; /* The z-index should be higher than Google Maps */
    opacity: .85;
}
#contactform {
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  margin-left: 530 ;
  margin-right: 20 ;
}
#incoming-request {
  display: none;
   z-index: 1; /* The z-index should be higher than Google Maps */
   opacity: .85; /* Set the opacity for a slightly transparent Google Form */
   width: 350;
  position: absolute;
  margin-left: 20%;
  margin-right: 80%;
}
#allRequests {
  display: none;
   z-index: 1; /* The z-index should be higher than Google Maps */
   opacity: .85; /* Set the opacity for a slightly transparent Google Form */
    position: absolute;
    margin-left: 30%;
     margin-right: 30%;
}
#chatwindow {
  display: none;
  position: relative;
    resize: both;
  margin-left: 300;
  margin-right: 300;
  bottom: 210px;
  height: 400px;
  z-index: 1;
}
#error {
  display: none;
  position: relative;
    margin-left: 550;
  margin-right: 540;
  opacity: .85;
  z-index: 1;
}
#recReq {
  display: none;
   position: absolute;
   margin-left: -45%;
  margin-right: -45%;
  z-index: 1;
}
#waiting {
  display: none;
}
#frm {
  display:inline
  }
#cancel_req {
  display: none;
}
#admin {
  display: none;
   position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  right: 20%;
  margin-left: 450 ;
  margin-right: 20 ;
}
#post {
  z-index: 1;
    margin-left: 530 ;
  margin-right: 60 ;
 margin-bottom: 10;
}
#post_comment{
  display: none;
}
#textarea_div{
  display: none;
}
#cancelgeopost {
  display: none;
}
#comments_div {
  height: 200px;
  overflow: auto;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.14/peer.js"></script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyAd_qUj056TQ8botUBBwAoRY8Mm5z4O8Lk&libraries=places"></script>
  <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/maplabel/src/map‌​label.js"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script>
$(document).ready(function(){
  console.log("script path : " + $(location).attr('pathname'));
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
   var peer;
  var global_call_var = null;
  var localMediaStream = null;
  var allMarkers = [];
  var allMarkerKeys = [];
  var markerExists = false;
   var gpp;
   var global_lat;
  var global_longi;
  var global_origin;
  var post_address;
  var $form    = $('#adduser');
  var $accReq = $('#accReq');
  var $decReq = $('#decReq');
  var $username = $('#UserNameRegister');
  var $registerBttn = $('#registerBttn');
  var $registerwell = $('#registerwell');
  var $sendReq = $('#bttn');
  var $wait = $('#waiting');
  var $sendmsg = $('#sendmsg');
  var $msg = $('#msg');
  var $infodiv = $('#infowell');
  var $msgbox = $('#msg');
  var $CWbttn = $('#closeChatWindow');
  var $OWbttn = $('#openChatWindow');
  var $cancelbttn = $('#cancelbttn');
  var $canceldiv = $('#cancel_req');
  var $closeshout = $("#closeshout");
  var $sendshoutbttn = $("#sendshoutbttn");
  var socket  = io.connect('http://45.55.159.108:80');
  var data_one;
  var data_two;
  var lat;
  var longi;
  var map;
  var uname;
  var identifier;
  var errFlag = false;
  var com_visible = false;
  var global_to;
  var global_from;
  var global_user;
    var isAdmin = false;
var colors = ["#31B404","#B40404","#08088A","#DF3A01","#8A0886"];
  $msgbox.prop("disabled", true);
  $username.prop('disabled', true);
  $registerBttn.prop('disabled', true);
  navigator.geolocation.watchPosition(function(position) {
  console.log("loc enabled");
      $username.prop('disabled', false);
       $registerBttn.prop('disabled', false);
      },
      function (error) { 
          if (error.code == error.PERMISSION_DENIED)
           console.log("location blocked");
           $('#error').html("<b><font color='white'>You must enable your browsers geolocation</font></b>");
           $('#error').show();
        });
  if (navigator.geolocation){
    geolocate();
    navigator.geolocation.getCurrentPosition(showPosition);
    window.onload = mpld();
    function mpld(){
      var str =" success ";
    //socket.emit("map-loaded", str);
     }
  function updateScroll(){
      var element = document.getElementById("messages");
      element.scrollTop = element.scrollHeight;
  }
     function updateShoutScroll(){
      var element = document.getElementById("s_msgs");
      element.scrollTop = 0;
  }
     function updateCommentsScroll(){
      var element = document.getElementById("comments_div");
      element.scrollTop = element.scrollHeight;
  }
  socket.on("send_posts", function(dataArr){
  if(dataArr.length > 0){
      for(var i=0; i < dataArr.length; i++){
        var latit =  parseFloat(dataArr[i].lat);
        var longit =  parseFloat(dataArr[i].longi);
          var ltlng = new google.maps.LatLng(latit,longit);
          var content = dataArr[i].content;
          var title = dataArr[i].user;
          var id = dataArr[i].id;
           var marker = place_perm_marker(ltlng, title, content, id); 
        }
      } 
    }); 
  $("#myModal").on("hidden.bs.modal", function(event){
  if(marker != null){
    marker.setMap(null);
    markerExists = false;
    gpp = null;
     google.maps.event.clearListeners(map, 'click');
     $("#cancelgeopost").hide();
     $("#pickspot").show();
    $("#post").show();
     
  }
});
  $('#view_post').on('hidden.bs.modal', function (event) {
    $("#post_user").html("");
    $("#post_content").html("");
    $("#comments_div").html("");
    $(".comments").show();
    $(".hide_comments").hide();
    $(".post_comment").hide();
     $("#textarea_div").hide();
});
socket.on("send-users", function(dataArr){
  if(dataArr.length > 0){
      for(var i=0; i < dataArr.length; i++){
        if(dataArr[i].username == uname){
        } else {
          console.log(dataArr[i].username);
          var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
           var marker = createmarker(ltlng, dataArr[i].username);
           allMarkers.push(marker);
           allMarkerKeys.push(dataArr[i].username);
           console.log("allMarkerKeys : " + allMarkerKeys);
          }
        }
      } else {
        console.log('no one online');
      }
    }); 
  }
  $infodiv.click(function(event){
    event.preventDefault();
    $infodiv.hide();
  });
  $sendReq.click(function(event){
    event.preventDefault();
    socket.emit("chat-request", identifier, uname);
    $sendReq.hide();
    $wait.show();
    $canceldiv.show();
  });
  $cancelbttn.click(function(event){
    event.preventDefault();
    socket.emit("cancelRequest",  identifier, uname);
  })
  socket.on("show-client-req", function(to, from){
    global_to = to;
    global_from = from;
    if($('#chatwindow').is(":visible")){
      $('#chatwindow').hide();
     }
    $('#allRequests').show();
     $('#header').html("<h1>Chat Request From " + from + "</h1>");
       $('#incoming-request').show();
         $('#recReq').show();
           $('#allRequests').append($('#incoming-request'));
            console.log("request to chat from " + from);

  });
  socket.on("senderLeft", function(){
      console.log("event");
  $("#chatwindow").hide();
    $('#messages').empty();
           $('#stat').empty();
     $('#allRequests').hide();
        $("#stat").html("");
            $("#bttn").hide();
             $canceldiv.hide();
             $wait.hide();
  });
  $accReq.submit(function(event){
    event.preventDefault();
       socket.emit("accept", global_from, global_to);
  });
  $CWbttn.click(function(event){
    event.preventDefault();
      $('#chatwindow').hide();
        $('#hiddenChatWindow').show();
  });
  $OWbttn.click(function(event){
    event.preventDefault();
    $('#chatwindow').show();
     $('#hiddenChatWindow').hide();
  });
    $sendshoutbttn.click(function(event){
    event.preventDefault();
    var shoutmsg = $("#shouttextfield").val();
    if(null == uname){
      from = "anonymous";
    } else {
      from = uname;
    }
    socket.emit("send_shout", from, shoutmsg);
    $("#shouttextfield").val("");
  });
  $closeshout.click(function(event){
    event.preventDefault();
      $("#shout_content").hide();
       $("#hiddenShoutWindow").show();
  });
  $("#openShoutWindow").click(function(event){
    event.preventDefault();
     $("#shout_content").show();
     $("#hiddenShoutWindow").hide();
  });
 $("#sendshoutform").submit(function(event){
    event.preventDefault();
    var shoutmsg = $("#shouttextfield").val();
    if(null == uname){
      from = "anonymous";
    } else {
      from = uname;
    }
    socket.emit("send_shout", from, shoutmsg, isAdmin);
    $("#shouttextfield").val("");
  });
socket.on("admin",function(admin_msg, username, latit, longit){
  uname = username;
  lat = latit;
  longi = longit;
   $form.hide();
        $('#error').hide();
          $registerwell.hide();
  $("#admin_message").html("<b> " + admin_msg + "</b>");
    $("#admin").show();
  
});
socket.on("bad_credentials", function(msg){
   $registerwell.show();
   $('#error').html("<b><font color='white'>" + msg + " </font></b>");
   $("#error").show();
   $form.show();
   $("#admin").hide();
});
$("#adminloginbttn").click(function(event){
  event.preventDefault();
  var pass = $("#loginadmin").val();
  socket.emit("check_cred", pass, uname, lat, longi);
});
$("#admin_l").submit(function(event){
  event.preventDefault();
  var pass = $("#loginadmin").val();
  socket.emit("check_cred", pass, uname, lat, longi);
});
  socket.on("post_shout", function(from, msg){
    var ind_color = Math.floor((Math.random() * 4) + 0);
    var color = colors[ind_color];
    $("#s_msgs").prepend("<b><font color=" + color + "> " + from + "</font> : " + msg + "</b><br>");
    updateShoutScroll();
  });
  socket.on("post_admin_shout", function(from, msg, data){
    var ind_color = Math.floor((Math.random() * 4) + 0);
    var color = colors[ind_color];
    var base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(data.image)));
    $("#s_msgs").prepend("<img height='14' width='14' src=data:image/png;base64," + base64String + "></img><b><font color=" + color + "> " + from + "</font> : " + msg + "</b><br>");
    updateShoutScroll();
  });
  socket.on("load_shouts", function(sender, message, isAdminPost, img){
    var ind_color = Math.floor((Math.random() * 4) + 0);
    var color = colors[ind_color];
    if(isAdminPost > 0){
      var base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(img.image)));
    $("#s_msgs").append("<img height='14' width='14' src=data:image/png;base64," + base64String + "></img><b><font color=" + color + "> " + sender + "</font> : " + message + "</b><br>");
    } else {
        $("#s_msgs").append("<b><font color=" + color + "> " + sender + "</font> : " + message + "</b><br>");
      }
  });
  $('#endbttn').click(function(event){
    event.preventDefault();
    socket.emit("end", uname);
    $('#chatwindow').hide();
       $('#messages').empty();
           $('#stat').empty();
            if(localMediaStream){
            localMediaStream.stop();
              }
  });
    socket.on("convEnded", function(isin, beingrq, cp){
    $('#chatwindow').hide();
       $('#messages').empty();
          $('#stat').empty();
            $('#media_one').empty();
              $('#media_two').empty();
              $('#media_one').html();
              $('#media_two').html();
    if((global_call_var != null)){
      global_call_var.close();
    }
    if(localMediaStream != null){
      localMediaStream.stop();
    }
    

    console.log(isin);
    console.log(beingrq);
    console.log(cp);

  });
  socket.on("joined", function(data1, data2){
      data_one = data1;
    $('#chatwindow').show();
    $canceldiv.hide();
    $msgbox.prop('disabled', false);
    $('#sendmsgbttn').prop('disabled', false);
    $('#endbttn').prop('disabled', false);
    $('#bttn').hide();
    $sendReq.hide();
    $wait.hide();
    $('#allRequests').hide();
    $('#stat').html(data1 + " is now talking to " + data2);
    $('#media_one').html('<video id="v" width="320" height="180" autoplay></video>');
   // $('#media_two').html('<video id="v2" width="320" height="180" autoplay></video>');
      navigator.getUserMedia({audio: true, video: true}, function(stream){
        // Set your video displays
        $('#v').prop('src', URL.createObjectURL(stream));
        localMediaStream = stream;
        window.localStream = stream;
        if(peer.id == data1) {
           peer.call(data2, stream);
         } else {
            peer.call(data1, stream);
          }
      }, function(err) {
            console.log('Failed to get local stream' ,err);
              });

            peer.on('call', function(call){
              global_call_var = call;
               call.answer(window.localStream); // Answer the call with an A/V stream.
              //  if (window.existingCall) {
              //     window.existingCall.close();
              //      }
               call.on('stream', function(stream) {
                 $('#media_two').html('<video id="v2" width="320" height="180" autoplay></video>');
                   $('#v2').prop('src', URL.createObjectURL(stream));
                    });
              });
  });
  $decReq.submit(function(event){
    event.preventDefault();
      $('#allRequests').hide();
       socket.emit("decline", global_from, uname);
  });
  socket.on("requestDeclined", function(data){
    $('#waiting').hide();
      $('#stat').html(data + " has declined your request =(");
             });
   $('#sendmsgbttn').click(function(event){
    event.preventDefault();
    console.log("from : " + global_user);
     $('#messages').append("<b>" + global_user + " : " +  $msg.val() + "</b><br>");
      socket.emit("message", global_user, $msg.val());
            $msg.val("");
                 });
  $sendmsg.submit(function(event){
    event.preventDefault();
      console.log("you : " + global_user);
      $('#messages').append("<b>" + global_user + " : " +  $msg.val() + "</b><br>");
      updateScroll();
       socket.emit("message", global_user, $msg.val());
          $msg.val("");
                 });
  socket.on("sendmsg", function(data, from){
   console.log("from : " + from);
         $('#messages').append("<b>" + from + " : " + data + "</b><br>");
            updateScroll();
                 });
  socket.on("dec", function(data){
   });
  $form.submit(function(event){
    event.preventDefault();
       if($username.val() == '' || null || undefined){
          $('#error').html("<b><font color='white'> must enter a user name </font></b>");
             $('#error').show();
    } else {
    uname = $username.val();
      if(errFlag){
          $('#error').hide();
      }
    socket.emit("check-in", $username.val(), lat, longi);
    socket.on("valid", function(message){
      if(message == "admin"){
        $("#admin").hide();
        isAdmin = true;
      }
       $form.hide();
        $('#error').hide();
          $registerwell.hide();
            peer = new Peer($username.val(), {key: 'j7c1qbwja038r529'});
              console.log("peer : " + peer.id);
              global_user = peer.id;
              var latlng = new google.maps.LatLng(lat,longi); 
               var marker = new google.maps.Marker({ 
                position: latlng, 
                map: map, 
                flat: true, 
                title: "Me : " + uname, 
                draggable: false 
             });
      
         iconFile = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'; 
        marker.setIcon(iconFile);
    });
    socket.on("register_error", function(err){
      $('#error').html("<b><font color='white'>" + err + "</font></b>");
       $('#error').show();
    });
       }
  });
 $("#pickspot").click(function(event){
   event.preventDefault();
    $("#pickspot").hide();
   $("#cancelgeopost").show();
  // $("#post").hide();
   google.maps.event.addListener(map, 'click', function(event){
       placeMarker(event.latLng);
    });
 });
 $("#cancelgeopost").click(function(event){
  google.maps.event.clearListeners(map, 'click');
  $("#pickspot").show();
   $("#cancelgeopost").hide();
  google.maps.event.clearListeners(map, 'click');
 });
 $("#make_post").click(function(event){
  event.preventDefault();
    var content = $("#post_cntnt").val();
    var user = "";
    if(uname == null){
      user = "anonymous";
    } else {
      user = uname;
    }
    var content = $("#post_cntnt").val();
    var post_lat = gpp.lat().toString().substr(0,8);
    var post_long = gpp.lng().toString().substr(0,8);
     socket.emit("store_post", user, content, post_lat, post_long, isAdmin);
 $("#myModal").modal('hide');
    $("#post_cntnt").val("");
       $("#post").show();
 });
 socket.on("add_post_to_map", function(user, content, lat, longi, id){
  console.log("id ::" + id);
  var post_lat = parseFloat(lat);
  var post_long = parseFloat(longi);
  var post_position = new google.maps.LatLng(post_lat, post_long);
  place_perm_marker(post_position, user, content, id);
});
$(".post_comment").click(function(event){
  event.preventDefault();
  console.log("COMMENT");
  var com_con = $("#comment_content").val();
  if(com_con.length < 1){
    $("#error").html("write something first");
  } else {
      var user = "";
    if(uname == null){
      user = "anonymous";
    } else {
      user = uname;
    }
    var key = $("#comments_div").data("key");
      console.log(key);
    socket.emit("post_comment", com_con, user, key, isAdmin);
    $("#comment_content").val("");
  }
});
socket.on("post", function(content, user, key){
    if($("#comments_div").data("key") == key){
      //append div with data for deletion 
      var ind_color = Math.floor((Math.random() * 4) + 0);
         var color = colors[ind_color];
       $("#comments_div").append("<b><font color=" + color + ">" + user + "</font></b> : " + content + "<hr>");
       updateCommentsScroll();
    }
});
  function showPosition(position){
       lat = position.coords.latitude.toString().substr(0,8);
       longi = position.coords.longitude.toString().substr(0,8);
       console.log("lat " + lat);
       console.log("long " + longi);
      //socket.emit()
      var mapOptions = {
        center : new google.maps.LatLng(lat,longi),
        zoom : 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
       map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
       socket.emit("map-loaded");
        socket.emit("get_all_shouts");
      var latlng = new google.maps.LatLng(lat,longi);
      google.maps.event.addDomListener(window, 'load', showPosition);
  }
  function showChatWindow(title){
            if(uname == undefined){
               $('#error').html("<b><font color='white'> Make a user name to send a chat request</font></b>")
                $('#error').show();
                 errFlag = true;
                   } else {
                  //$('#chatwindow').show();
                   identifier = title;

                  $('#chatwindow').show();
                  $('#bttn').attr('value', 'Send chat Request to ' + identifier);
                  $('#bttn').show();
                  $('#sendmsgbttn').prop('disabled',true);
                  $('#endbttn').prop('disabled',true);

          }
      } 

  function createmarker(pos, title){
    var mark = new google.maps.Marker({
                position: pos,
                map: map,
                title: title
          });
        google.maps.event.addListener(mark, 'click', function() {
          //check if is in conv
          //then modify and show chat window
          if($('#allRequests').is(":visible")){

          } else { 
          console.log("uname" + uname);
          if(uname == undefined){
            $('#error').html("<b><font color='white'> you must make a username first </font></b>");
            $('#error').show();
            errFlag = true;
          } else {
          socket.emit("check_status", title, uname);
          socket.on("return_status", function(status){
                    if(status == 3){
                     $('#stat').html("You are already in a conversation! don't be rude ");
                            }
                      else if(status == 2){
                      showChatWindow(mark.title);
                      $('#stat').empty();
                      $('#messages').empty();

                    } else if(status == 1){
                        showChatWindow(mark.title);
                        $('#bttn').hide();
                        $('#stat').html(mark.title + " is in a conversation ");
                    } else {
                              showChatWindow(mark.title);
                              $('#bttn').hide();
                              $('#stat').html(mark.title + " has a pending request ");
                     }
                  });
                }
              }
            });
             return mark;
       }
  function geolocate() {
            var input = document.getElementById('AddressRegister');
            var optns = {
                types: ['address']
            };
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
              });
            }
          }
function codeLatLng(lat, lng)
{
  var geocoder;
  geocoder = new google.maps.Geocoder();
  var latlng = new google.maps.LatLng(lat, lng);
  //Geocoder takes longitude and latitude and sets it to an adress.
  geocoder.geocode({'latLng': latlng}, function(results, status)
  {
if (status == google.maps.GeocoderStatus.OK)
    {
      if (results[1])
      {
    
        placeMarker(latlng, "addr");
        }
      }
    });
}
function place_perm_marker(position, title, content, id){
    var marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
         flat: true, 
            draggable: false, 
      });
        iconFile = 'http://www.oncampus.ws:8080/globe.png'; 
        marker.setIcon(iconFile);
   var lat_str = position.lat().toString().substr(0,8);
   var long_str = position.lng().toString().substr(0,8);
        marker.addListener('click', function(){
            $("#view_post").modal('show');
            $("#comments").data("key", id);
            $("#post_user").html("Posted by " + title);
            $("#post_content").html("<b><h3>" + content + "</b></h3>");
socket.emit("get_comments", id);
socket.on("serve_comments", function(data){
    $("#comments_div").html("");
    $("#comments_div").data("key", id);
    console.log(data);
   for(var i=0; i < data.length; i++){
       var ind_color = Math.floor((Math.random() * 4) + 0);
         var color = colors[ind_color];
    $("#comments_div").append("<b><font color=" + color +">" + data[i].user + "</font></b> : " + data[i].content + "<hr>");
    updateCommentsScroll();
   }
    $("#textarea_div").attr("placeholder","write a response");
     $("#textarea_div").show();
    $("#post_comment").show();
  });
socket.on("no_comments", function(data){
    $("#comments_div").html("<b>No comments yet</b><br><hr>");
    $("#comments_div").data("key", id);
    $("#textarea_div").attr("placeholder", "write a response");
    $("#textarea_div").show();
    $("#post_comment").show();
  });
            console.log("button data attr : " + $("#comments").data("key"));
        });
}
function placeMarker(location)
{
  $("#post").hide();
   if(markerExists){} else {
     marker = new google.maps.Marker({
        position: location,
        map: map,
         flat: true, 
            draggable: false, 
    });
              iconFile = 'http://www.oncampus.ws:8080/globe.png'; 
        marker.setIcon(iconFile);
    map.setCenter(marker.getPosition());
    markerExists = true;
    gpp = marker.getPosition();
     if(marker.visible){
        $('#myModal').modal();
      console.log(marker.position);
     }
   }
}
   socket.on("remove-marker", function(data){
            console.log(data);
            for(var x=0; x<allMarkers.length; x++){
              if(allMarkers[x].title == data){
                var temp = allMarkers[x].title;
                allMarkers[x].setMap(null);
              }
            }
                console.log("Marker remove request recieved");
          });
                socket.on("update-map", function(dataArr){
                  for(var x=0; x<allMarkers.length; x++){
                           allMarkers[x].setMap(null);
                       }
                  allMarkers = [];
            for(var i=0; i < dataArr.length; i++){
                if(allMarkers.indexOf(dataArr[i].username) == -1){} else {
                  allMarkers.splice(indexOf(dataArr[i].username), 1);
                }
         if(dataArr.length > 1){
              if(i == dataArr.length-1){
                 if((dataArr[i].lat ||  dataArr[i].longi)==(dataArr[i-1].lat ||  dataArr[i-1].longi)){
                    // This is concatenating 0.0003112 onto end of string - parse to int
                  dataArr[i].lat = parseFloat(dataArr[i].lat) + 0.0006165;
                  dataArr[i].longi = parseFloat(dataArr[i].longi) + 0.0004165;
                  console.log("After location Modification  " + dataArr[i].lat);
                }
              } else {
                if((dataArr[i].lat ||  dataArr[i].longi)==(dataArr[i+1].lat ||  dataArr[i+1].longi)){
                        // This is concatenating 0.0003112 onto end of string - parse to int
                  dataArr[i].lat = parseFloat(dataArr[i].lat) + 0.0004165;
                  dataArr[i].longi = parseFloat(dataArr[i].longi) + 0.0006165;
                  console.log("After location Modification  " + dataArr[i].lat);
                   }
             }
        }
            if(dataArr[i].username == uname){
            } else {
            var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
            var marker = createmarker(ltlng, dataArr[i].username);
            allMarkers.push(marker);
            }
       }
       console.log("listing markers array from map update ");
       for(var i=0; i < allMarkers.length; i++){
          console.log("Marker : " + i + " " + allMarkers[i].title);
                }
          });
 // close document.ready 
    });
</script>
