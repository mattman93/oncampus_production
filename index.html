 <html>
 <body>
   <div id ="infowell" class="well well-lg">
    <center><div>
  <b>Welcome to OnCampus, make a user name and look for the red markers<br>
     Click on the markers to send a chat a request</b></div><div>
     <a href="" id="closeinfo">
     Close <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></div>
     </center>
 </div>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
   <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<br><br><br><br><br><br><br><br><br><br><br><br><br><center>
<div id="allRequests"></div>
<div id="incoming-request">
  <div id ="requestWell" class="well well-lg">
    <div id="header"></div>
           <form id="accReq">
           <input type="submit" class="btn btn-success" id="btn" style="margin-left:5; margin-right:300;height:50px;width:300px;" value="Accept"></input>
         </form>
         <form id="decReq">
           <input type="submit" class="btn btn-danger" id="btn" style="margin-left:5; margin-right:300;height:50px;width:300px;" value="Decline"></input>
         </form>
  </div>
</div>
<div id="error"></div>
  <div id="contactform">
    <div class="col-sm-4">
          <div id ="registerwell" class="well well-lg">
            <center>
              <form role="form" id="adduser" method="POST">
              <div class="form-group">
                <label for="UserNameRegister">Username</label>
                <input type="text" name = "registerusername" class="form-control" id="UserNameRegister" placeholder="Register Username">
                 <input type="submit" style="height:35px; width:65px" value="register" id="registerBttn"></input>
              </div>
          </div>
         </div>
     </div>


<div class="panel panel-primary" id="chatwindow">
      <br><center>
        <div id="messages"></div>
      <div id="waiting"><b>Waiting...</b></div>
      <form id="chatReq">
      <input type="submit" class="btn btn-primary" id="bttn" value=""></input>
      </form>
      </center>
        <div class="input-group input-group-lg" id="messageSendDiv">
          <form role="form" id="sendmsg" method="post"> 
          <div class="form-group">
          <input type="text" id="msg" class="form-control" placeholder="Message">&nbsp
            <!-- <input type="submit" style="height:45px;width:70px;" value="send" id="sendmsgbttn"></input> -->
             <button type="button" class="btn btn-success" id="sendmsgbttn">Send Message</button>
            <button type="button" class="btn btn-danger" id="endbttn">End Conversation</button>
           <!-- <input type="submit" style="height:45px;width:70px;" value="end conversation" id="endbttn"></input> -->
          </div>
     </form> 
      <div><a href="" id="closeChatWindow"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Hide Window</a></div>
      <table><tr><td>
    <div id="media_one"></div>
      </td><td>
    <div id="media_two"></div></td></tr></table>
   </div>
   <div id="stat"></div>
</div>
 </center>
  <div id="map-canvas" style="width: 100%; height: 100%"></div>
  <div id="hiddenChatWindow" class="well well-lg">
<div><a href="" id="openChatWindow"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Show Window</a></div>
</div>
</body>
</html>   
<style type="text/css">
#messages
{
   height:80px;
    overflow:scroll;
    overflow-x:hidden;
}
#hiddenChatWindow {
  display: none;
  position: absolute;
  z-index: 1;
   opacity: .95;
   bottom: 2px;
}
#map-canvas {
  height: 100%;
  width: 100%;
  position:absolute;
  top: 0;
  left: 0;
  z-index: 0;
}
#infowell {
   position: relative;
    z-index: 1; /* The z-index should be higher than Google Maps */
    opacity: .85;
}
#contactform {
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  margin-left: 530 ;
  margin-right: 20 ;
}
#incoming-request {
  display: none;
   z-index: 1; /* The z-index should be higher than Google Maps */
   opacity: .85; /* Set the opacity for a slightly transparent Google Form */
   width: 350;
  position: relative;
  margin-left: 20%;
  margin-right: 80%;
}
#allRequests {
  display: none;
   z-index: 1; /* The z-index should be higher than Google Maps */
   opacity: .85; /* Set the opacity for a slightly transparent Google Form */
    position: relative;
    margin-left: 30%;
     margin-right: 30%;
}
#chatwindow {
  display: none;
  position: relative;
    resize: both;
  margin-left: 300;
  margin-right: 300;
  bottom: 210px;
  height: 400px;
  z-index: 1;
}
#error {
  display: none;
  position: relative;
  z-index: 1;
}
#recReq {
  display: none;
   position: relative;
   margin-left: -45%;
  margin-right: -45%;
  z-index: 1;
}
#waiting {
  display: none;
}
#frm {
  display:inline
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.14/peer.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js">
  </script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyAd_qUj056TQ8botUBBwAoRY8Mm5z4O8Lk&libraries=places"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script src="http://45.55.159.108:80/socket.io/socket.io.js"></script>
<script>
$(document).ready(function(){
  console.log("script path : " + $(location).attr('pathname'));
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
  var peer;
  var global_call_var = null;
  var localMediaStream = null;
  var allMarkers = [];
  var allMarkerKeys = [];
  var $form    = $('#adduser');
  var $accReq = $('#accReq');
  var $decReq = $('#decReq');
  var $username = $('#UserNameRegister');
  var $registerBttn = $('#registerBttn');
  var $registerwell = $('#registerwell');
  var $sendReq = $('#bttn');
  var $wait = $('#waiting');
  var $sendmsg = $('#sendmsg');
  var $msg = $('#msg');
  var $infodiv = $('#infowell');
  var $msgbox = $('#msg');
  var $CWbttn = $('#closeChatWindow');
  var $OWbttn = $('#openChatWindow');
  var socket  = io.connect('http://45.55.159.108:80');
  var data_one;
  var data_two;
  var lat;
  var longi;
  var map;
  var uname;
  var identifier;
  var errFlag = false;
  var global_to;
  var global_from;
  $msgbox.prop("disabled", true);
  $username.prop('disabled', true);
  $registerBttn.prop('disabled', true);
  navigator.geolocation.watchPosition(function(position) {
  console.log("loc enabled");
      $username.prop('disabled', false);
       $registerBttn.prop('disabled', false);
      },
      function (error) { 
          if (error.code == error.PERMISSION_DENIED)
           console.log("location blocked");
           $('#error').html("<b>You must enable your browsers geolocation</b>");
           $('#error').show();
        });
  if (navigator.geolocation){
    geolocate();
    navigator.geolocation.getCurrentPosition(showPosition);
    window.onload = mpld();
    function mpld(){
      var str =" success ";
    //socket.emit("map-loaded", str);
     }
  function updateScroll(){
      var element = document.getElementById("messages");
      element.scrollTop = element.scrollHeight;
  }
socket.on("send-users", function(dataArr){
  if(dataArr.length > 0){
      for(var i=0; i < dataArr.length; i++){
        if(dataArr[i].username == uname){
        } else {
          console.log(dataArr[i].username);
          var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
           var marker = createmarker(ltlng, dataArr[i].username);
           allMarkers.push(marker);
           //allMarkerKeys.push(dataArr[i].username);
           console.log("allMarkerKeys : " + allMarkerKeys);
          }
        }
      } else {
        console.log('no one online');
      }
    }); 
  }
  $infodiv.click(function(event){
    event.preventDefault();
    $infodiv.hide();
  });
  $sendReq.click(function(event){
    event.preventDefault();
    socket.emit("chat-request", identifier, uname);
    $sendReq.hide();
    $wait.show();
  });
  socket.on("show-client-req", function(to, from){
    global_to = to;
    global_from = from;
    if($('#chatwindow').is(":visible")){
      $('#chatwindow').hide();
     }
    $('#allRequests').show();
     $('#header').html("<h1>Chat Request From " + from + "</h1>");
       $('#incoming-request').show();
         $('#recReq').show();
           $('#allRequests').append($('#incoming-request'));
            console.log("request to chat from " + from);

  });
  socket.on("senderLeft", function(){
     $('#allRequests').hide();
        $("#stat").html();
            $("#bttn").hide();
  });
  $accReq.submit(function(event){
    event.preventDefault();
       socket.emit("accept", global_from, global_to);
  });
  $CWbttn.click(function(event){
    event.preventDefault();
      $('#chatwindow').hide();
        $('#hiddenChatWindow').show();
  });
  $OWbttn.click(function(event){
    event.preventDefault();
    $('#chatwindow').show();
     $('#hiddenChatWindow').hide();
  });
  $('#endbttn').click(function(event){
    event.preventDefault();
    socket.emit("end", uname);
    $('#chatwindow').hide();
       $('#messages').empty();
           $('#stat').empty();
            if(localMediaStream){
            localMediaStream.stop();
              }
  });
    socket.on("convEnded", function(isin, beingrq, cp){
    $('#chatwindow').hide();
       $('#messages').empty();
          $('#stat').empty();
            $('#media_one').empty();
              $('#media_two').empty();
    if((global_call_var && localMediaStream) != '' || undefined || null){
      global_call_var.close();
      localMediaStream.stop();
    }

    console.log(isin);
    console.log(beingrq);
    console.log(cp);

  });
  socket.on("joined", function(data1, data2){
      data_one = data1;
    $('#chatwindow').show();
    $msgbox.prop('disabled', false);
    $('#sendmsgbttn').prop('disabled', false);
    $('#endbttn').prop('disabled', false);
    $('#bttn').hide();
    $sendReq.hide();
    $wait.hide();
    $('#allRequests').hide();
    $('#stat').html(data1 + " is now talking to " + data2);
    $('#media_one').html('<video id="v" width="320" height="180" autoplay></video>');
    $('#media_two').html('<video id="v2" width="320" height="180" autoplay></video>');
      navigator.getUserMedia({audio: false, video: true}, function(stream){
        // Set your video displays
        $('#v').prop('src', URL.createObjectURL(stream));
        localMediaStream = stream;
        window.localStream = stream;
        if(peer.id == data1) {
           peer.call(data2, stream);
         } else {
            peer.call(data1, stream);
          }
      }, function(err) {
            console.log('Failed to get local stream' ,err);
              });

            peer.on('call', function(call){
              global_call_var = call;
               call.answer(window.localStream); // Answer the call with an A/V stream.
                if (window.existingCall) {
                   window.existingCall.close();
                    }
               call.on('stream', function(stream) {
                   $('#v2').prop('src', URL.createObjectURL(stream));
                    });
              });

  });
  function handleCall(call){
                    // Wait for stream on the call, then set peer video display
                    call.on('stream', function(stream){
                      $('#v2').prop('src', URL.createObjectURL(stream));
                    });
                  window.existingCall = call;
                 }
   function video(){
   navigator.getUserMedia = (navigator.getUserMedia || 
                             navigator.webkitGetUserMedia || 
                             navigator.mozGetUserMedia || 
                             navigator.msGetUserMedia);

      navigator.getUserMedia({video: true, audio: false}, function(stream) {
        console.log("peer identifier " +identifier);
        var call = peer.call(identifier, stream);
        call.on('stream', function(remoteStream) {
            var v = document.getElementById('v');
                  var url = window.URL || window.webkitURL;
                    v.src = url ? url.createObjectURL(remoteStream) : remoteStream;
                     v.play();
                      });
                  }, function(err) {
            console.log('Failed to get local stream' ,err);
              });

    peer.on('call', function(call) {
      navigator.getUserMedia({video: true, audio: false}, function(stream) {
                 call.answer(stream); // Answer the call with an A/V stream.
                    call.on('stream', function(remoteStream) {
                        var v2 = document.getElementById('v2');
                         var url = window.URL || window.webkitURL;
                         v2.src = url ? url.createObjectURL(remoteStream) : remoteStream;
                          v2.play();
                       
          // Show stream in some video/canvas element.
                         });
                    }, function(err) {
                   console.log('Failed to get local stream' ,err);
                    });
              });
 }
  $decReq.submit(function(event){
    event.preventDefault();
      $('#allRequests').hide();
       socket.emit("decline", global_from, uname);
  });
  socket.on("requestDeclined", function(data){
    $('#waiting').hide();
      $('#stat').html(data + " has declined your request =(");
             });
  $('#sendmsgbttn').click(function(event){
    event.preventDefault();
      socket.emit("message", data_one, $msg.val());
            $msg.val("");
                 });
  $sendmsg.submit(function(event){
    event.preventDefault();
       socket.emit("message", data_one, $msg.val());
          $msg.val("");
                 });
  socket.on("sendmsg", function(data, you){
    console.log("self : " + you);
         $('#messages').append("<b>" + you + " : " + data + "</b><br>");
            updateScroll();
                 
                 });
  socket.on("dec", function(data){
   });
  $form.submit(function(event){
   var valid = false;
    event.preventDefault();
       if($username.val() == '' || null || undefined){
          $('#error').html("<b> must enter a user name </b>");
             $('#error').show();
        valid = true;
    } else {
    uname = $username.val();
      if(errFlag){
          $('#error').hide();
      }
    socket.emit("check-in", $username.val(), lat, longi);
      $form.hide();
        $('#error').hide();
          $registerwell.hide();
            peer = new Peer($username.val(), {key: 'j7c1qbwja038r529'});
              console.log("peer : " + peer.id);
       }
    if(!valid){
        var latlng = new google.maps.LatLng(lat,longi); 
          var marker = new google.maps.Marker({ 
            position: latlng, 
            map: map, 
            flat: true, 
            title: "Me : " + uname, 
            draggable: false 
         });
         iconFile = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'; 
        marker.setIcon(iconFile);
      }
  });
  function showPosition(position){
       lat = position.coords.latitude.toString().substr(0,8);
       longi = position.coords.longitude.toString().substr(0,8);
       console.log("lat " + lat);
       console.log("long " + longi);
      //socket.emit()
      var mapOptions = {
        center : new google.maps.LatLng(lat,longi),
        zoom : 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      }
       map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
       socket.emit("map-loaded");
      var latlng = new google.maps.LatLng(lat,longi);
      google.maps.event.addDomListener(window, 'load', showPosition);
  }
  function showChatWindow(title){
            if(uname == undefined){
               $('#error').html("<b> Make a user name to send a chat request</b>")
                $('#error').show();
                 errFlag = true;
                   } else {
                  //$('#chatwindow').show();
                   identifier = title;

                  $('#chatwindow').show();
                  $('#bttn').attr('value', 'Send chat Request to ' + identifier);
                  $('#bttn').show();
                  $('#sendmsgbttn').prop('disabled',true);
                  $('#endbttn').prop('disabled',true);

          }
      } 

  function createmarker(pos, title){
    var mark = new google.maps.Marker({
                position: pos,
                map: map,
                title: title
          });
        google.maps.event.addListener(mark, 'click', function() {
          //check if is in conv
          //then modify and show chat window
          if($('#allRequests').is(":visible")){

          } else { 
          console.log("uname" + uname);
          if(uname == undefined){
            $('#error').html("<b> you must make a username first </b>");
            $('#error').show();
            errFlag = true;
          } else {
          socket.emit("check_status", title, uname);
          socket.on("return_status", function(status){
                    if(status == 3){
                     $('#stat').html("You are already in a conversation! don't be rude ");
                            }
                      else if(status == 2){
                      showChatWindow(mark.title);
                      $('#stat').empty();
                      $('#messages').empty();

                    } else if(status == 1){
                        showChatWindow(mark.title);
                        $('#bttn').hide();
                        $('#stat').html(mark.title + " is in a conversation ");
                    } else {
                              showChatWindow(mark.title);
                              $('#bttn').hide();
                              $('#stat').html(mark.title + " has a pending request ");
                     }
                  });
                }
              }
            });
             return mark;
       }
  function geolocate() {
            var input = document.getElementById('AddressRegister');
            var optns = {
                types: ['address']
            };
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
              });
            }
          }
 socket.on("remove-marker", function(data){
            console.log(data);
            for(var x=0; x<allMarkers.length; x++){
              if(allMarkers[x].title == data){
                var temp = allMarkers[x].title;
                allMarkers[x].setMap(null);
              }
            }
                console.log("Marker remove request recieved");
          });
                socket.on("update-map", function(dataArr){
                  for(var x=0; x<allMarkers.length; x++){
                           allMarkers[x].setMap(null);
                       }
                  allMarkers = [];
            for(var i=0; i < dataArr.length; i++){
                if(allMarkers.indexOf(dataArr[i].username) == -1){} else {
                  allMarkers.splice(indexOf(dataArr[i].username), 1);
                }
         if(dataArr.length > 1){
              if(i == dataArr.length-1){
                 if((dataArr[i].lat ||  dataArr[i].longi)==(dataArr[i-1].lat ||  dataArr[i-1].longi)){
                    // This is concatenating 0.0003112 onto end of string - parse to int
                  dataArr[i].lat = parseFloat(dataArr[i].lat) + 0.0006165;
                  dataArr[i].longi = parseFloat(dataArr[i].longi) + 0.0004165;
                  console.log("After location Modification  " + dataArr[i].lat);
                }
              } else {
                if((dataArr[i].lat ||  dataArr[i].longi)==(dataArr[i+1].lat ||  dataArr[i+1].longi)){
                        // This is concatenating 0.0003112 onto end of string - parse to int
                  dataArr[i].lat = parseFloat(dataArr[i].lat) + 0.0004165;
                  dataArr[i].longi = parseFloat(dataArr[i].longi) + 0.0006165;
                  console.log("After location Modification  " + dataArr[i].lat);
                   }
             }
        }
            if(dataArr[i].username == uname){
            } else {
            var ltlng = new google.maps.LatLng(dataArr[i].lat,dataArr[i].longi);
            var marker = createmarker(ltlng, dataArr[i].username);
            allMarkers.push(marker);
            }
       }
       console.log("listing markers array from map update ");
       for(var i=0; i < allMarkers.length; i++){
          console.log("Marker : " + i + " " + allMarkers[i].title);
                }
          });
 // close document.ready 
    });
</script>
